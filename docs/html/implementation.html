<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Conclusions" href="conclusion.html" /><link rel="prev" title="The problem" href="problem.html" />

    <link rel="shortcut icon" href="_static/favicon.ico"/><meta name="generator" content="sphinx-3.5.2, furo 2021.02.28.beta28"/>
        <title>Implementation - ROTehc docs</title>
      <link rel="stylesheet" href="_static/styles/furo.css?digest=be5985a4059b5c2cd56ed0804790452beca62674">
    <link rel="stylesheet" href="_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" href="_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">ROTehc docs</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="_static/banner.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="_static/banner.png" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="problem.html">The problem</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="conclusion.html">Conclusions</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ROTehc">GitHub</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="ae-nodemcu">
<h2>AE: nodeMCU<a class="headerlink" href="#ae-nodemcu" title="Permalink to this headline">¶</a></h2>
<p>The nodeMCU is a low-cost open-source IoT platform. Its firmware runs on the ESP8266 Wi-Fi SoC.</p>
<div class="section" id="sensor-nodes">
<h3>Sensor nodes<a class="headerlink" href="#sensor-nodes" title="Permalink to this headline">¶</a></h3>
<p>This device has several gas sensors as MG-811 in order to measure the CO2 and other gases in air. It also counts with a LCD display to show some operational information.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>As the time and budget were limited, it was not possible to buy the sensors, instead it was decided to simulate the signals by software in the nodeMCU itself.</p>
</div>
<p>The aspect of the first prototype would be like this:</p>
<img alt="_images/mk1.jpg" class="align-center" src="_images/mk1.jpg"/>
<p>It would consist of a rectangular case with all the components inside and a transparent region in order to see the LCD display. It would have a DC port in order to provide the power to the device.</p>
<p>For ocasions when the power supply is a problem, Lite version was developed. This version would be equiped with a 18650 battery and a small solar panel. In addition, the device wouldn’t have LCD display and would enter in deep sleep when not in use to save energy.</p>
<img alt="_images/lite.jpg" class="align-center" src="_images/lite.jpg"/>
<p>Every nodeMCU sends its data every amount of time (defined by the user) to the CSE over HTTP POST requests.</p>
<p>Each sensor node device, on first start, registers itself at the CSE with the information specified in the header of the .ino script, then creates the LOCATION container with its location, and then the DATA container. To avoid conflicts, the routine is aborted if the AE already exists at the CSE.</p>
<p>Each sensor node has its own container inside sensors group AE. Inside the nodes there are 2 containers, DESCRIPTOR and DATA:</p>
<ul class="simple">
<li><p><strong>LOCATION</strong> has one content instance inside with the location of the device stored in JSON format:</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">"lon"</span><span class="p">:</span> <span class="mf">-4.45</span><span class="p">,</span> <span class="nt">"lat"</span><span class="p">:</span> <span class="mf">36.71</span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>DATA</strong> its dedicated to store the readings from the device. Each content instance uses a JSON format to store all sensors readings:</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="nt">"co2"</span> <span class="p">:</span> <span class="mi">658</span><span class="p">,</span>
 <span class="nt">"o3"</span> <span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
 <span class="nt">"no2"</span> <span class="p">:</span> <span class="mi">116</span><span class="p">,</span>
 <span class="nt">"so2"</span> <span class="p">:</span> <span class="mi">168</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="actuator-nodes">
<h3>Actuator nodes<a class="headerlink" href="#actuator-nodes" title="Permalink to this headline">¶</a></h3>
<p>When an Actuator Node boots create a container under the Smart App’s Actuators container with a resource name specified in its configuration.</p>
<p>Then it will create a QUALITY container to store an Air Quality Index (AQI) and a LOCATION container where it will upload its position just once.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Actuator Node could be placed almost everywhere and show it’s AQI value in a lot of different ways, making it a really flexible platform.</p>
</div>
<p>Once the QUALITY container has been created it will create a subscription to it in order to be notified every time a new relevant AQI is sent from the Smart App.</p>
<p>When a new AQI arrives at the Actuator Node, it will decide what to do based on the danger the AQI represents. Since the AQI goes from 1 (poor quality, high danger) to 10 (excellent quality, low danger), we can use color LEDs, display it on screens or even actuate servo motors to move indicators like a speedometer does.</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\[AQI(x) = 11-\max\left({10\cdot\min\left({1,\frac{(x- \mathit{L})}{\mathit{H} - \mathit{L}}}\right),1}\right)\]</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span class="math notranslate nohighlight">\(L=low, H=high\)</span></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This devices are only prototypes. Correct operation is not guaranteed.</p>
</div>
</div>
</div>
<div class="section" id="in-cse-acme">
<h2>in-CSE: ACME<a class="headerlink" href="#in-cse-acme" title="Permalink to this headline">¶</a></h2>
<p>Our system architecture is based on OneM2M Service Layer developed by engineers from European Telecomunications Standards Institute. There is a infrastructure node called CSE, a group of nodeMCU devices with gas sensors, and another group with actuators, distribuited all over the territory, and an SmartApp as application entity to visualize the data.</p>
<p>The in-CSE is built over <a class="reference external" href="https://github.com/ankraft/ACME-oneM2M-CSE">ACME</a>, an open-source light implementation of subset of oneM2M standard specializations written in Python.</p>
<a class="reference internal image-reference" href="_images/acme_sm.png"><img alt="_images/acme_sm.png" class="align-center" src="_images/acme_sm.png" style="width: 150px;"/></a>
<p>The resources tree is the following:</p>
<img alt="_images/arch.png" class="align-center" src="_images/arch.png"/>
<p>The CSE contains the AE SmartApp. This entity has two containers which are Sensors, and Actuators.</p>
<ul class="simple">
<li><p>The Sensors container stores all the sensor nodes, each node has a container storing its location in json format in the LOCATION container and the recorded measures in json format in the DATA container.</p></li>
<li><p>The Actuators container stores all the actuator nodes, each actuator has two containers, LOCATION (same as in sensor nodes) and QUALITY. The QUALITY container stores the Air Quality Index which is calculated at the Smart App based in the nearest sensors readings, each node is subscribed to its own QUALITY container in order to show the last updated information.</p></li>
</ul>
</div>
<div class="section" id="smart-app">
<h2>Smart app<a class="headerlink" href="#smart-app" title="Permalink to this headline">¶</a></h2>
<p>The web-app is written with Vue.js framework. The app fetches the data from the CSE, parses the JSON, and displays it on a map.</p>
<img alt="_images/webapp.jpg" src="_images/webapp.jpg"/>
<p>Each IoT device is plotted as a point on the map, forming cells for each node according to Voronoi diagrams.</p>
<a class="reference internal image-reference" href="_images/voronoi.png"><img alt="_images/voronoi.png" class="align-center" src="_images/voronoi.png" style="width: 350px;"/></a>
<p>A Voronoi diagram is a nearest neighbor diagram: given a set of generator points, the Voronoi diagram creates nearest neighbor cells. Each cell is formed around one generator point, and the set of points closest to that generator is fully contained in its cell. The resulting diagram can be used to find the nearest generator for an arbitrary point or to interpolate the blank space around each generator to create a heatmap.</p>
<p>In the following image it could be seen the advantages of a Voronoi diagram over a scatter plot:</p>
<img alt="_images/california.jpeg" src="_images/california.jpeg"/>
<p>The app also provides average gas concentrations and a selector of gases to show on map. The app pulls every nodeMCU sensor data from the CSE, and plots it.</p>
</div>
<div class="section" id="backend">
<h2>Backend<a class="headerlink" href="#backend" title="Permalink to this headline">¶</a></h2>
<p>The Smart App will be a backend service subscribed to the CSE.</p>
<p>Every time a new Sensor Node or Actuator Node is created in the CSE the Smart App will store its resource name and coordinates in two separate data structures, one for Sensor Nodes and another one for Actuator Nodes. This system makes the calculation of distances and AQI reporting really fast.</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kr">interface</span> <span class="nx">Coordinates</span> <span class="p">{</span>
        <span class="nx">lat</span>: <span class="kt">number</span><span class="p">;</span>
        <span class="nx">lon</span>: <span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Readings</span> <span class="p">{</span>
        <span class="nx">co2</span>: <span class="kt">number</span><span class="p">;</span>
        <span class="nx">o3</span>: <span class="kt">number</span><span class="p">;</span>
        <span class="nx">no2</span>: <span class="kt">number</span><span class="p">;</span>
        <span class="nx">so2</span>: <span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">Node</span> <span class="p">{</span>
        <span class="nx">coordinates</span>: <span class="kt">Coordinates</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">SensorNode</span> <span class="kr">extends</span> <span class="nx">Node</span> <span class="p">{</span>
        <span class="nx">readings</span>: <span class="kt">Readings</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ActuatorNode</span> <span class="kr">extends</span> <span class="nx">Node</span> <span class="p">{</span>
        <span class="nx">closest</span>: <span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">sensorNodes</span>: <span class="kt">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="nx">SensorNode</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span> <span class="c1">// rn =&gt; SensorNode</span>
<span class="kr">const</span> <span class="nx">actuatorNodes</span>: <span class="kt">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ActuatorNode</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span> <span class="c1">// rn =&gt; ActuatorNode</span>
</pre></div>
</div>
<p>When a new Sensor Node is created, the Smart App will add it to the sensorNodes map and update the actuatorNodes map so each actuator points to their closest sensor.</p>
<p>When a new Actuator Node is created, the Smart App will calculate just its closest sensor and then add it to the actuatorNodes map.</p>
<p>When new readings arrive at the CSE from a Sensor Node, the Smart App will filter the actuators and take those who have the reporting sensor’s resource name as their closest sensor.</p>
<p>Then it will calculate the reading’s AQI and send its value to the relevant actuators.</p>
<p>The Smart App will also be responsible for sending data to the frontend when requested.</p>
<p>The backends runs over <a class="reference external" href="https://deno.land/">Deno</a>, a modern runtime for TypeScript.</p>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="conclusion.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Conclusions</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="problem.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">The problem</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, Rubén Jimenez Reina, Oleg Brezitskyy
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="_sources/implementation.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Implementation</a><ul>
<li><a class="reference internal" href="#ae-nodemcu">AE: nodeMCU</a><ul>
<li><a class="reference internal" href="#sensor-nodes">Sensor nodes</a></li>
<li><a class="reference internal" href="#actuator-nodes">Actuator nodes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#in-cse-acme">in-CSE: ACME</a></li>
<li><a class="reference internal" href="#smart-app">Smart app</a></li>
<li><a class="reference internal" href="#backend">Backend</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>